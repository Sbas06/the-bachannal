---
import { Image } from 'astro:assets';
import type { SliderContent } from '@/types/types';
import '@/components/SliderBanner/sliderBanner.css';

const {
  isSlider,
  content,
  contentPosition,
  isWhitehella,
  imageLoading,
  paginationPosition,
  id: propId,
}: {
  isSlider?: boolean;
  contentPosition?: string;
  content?: SliderContent;
  isWhitehella?: boolean;
  imageLoading?: 'eager' | 'lazy';
  paginationPosition?: 'pagLeft' | 'pagRight';
  id?: string;
} = Astro.props;

// Locale actual
const currentLang = Astro.currentLocale ?? 'es';

// Upload translations (build-time)
const translations = import.meta.glob('/src/i18n/*.ts', { eager: true }) as Record<string, any>;
const messages =
  translations[`/src/i18n/${currentLang}.ts`]?.default
  ?? translations[`/src/i18n/${currentLang}.js`]?.default
  ?? {};

// Determine effectiveId for lookup in i18n
let effectiveId: string | undefined;
if (propId && (messages?.slider?.[propId] || messages?.sliderBanner?.[propId])) {
  effectiveId = propId;
} else if (content?.id && (messages?.sliderBanner?.[content.id] || messages?.sliderBanner?.[content.id])) {
  effectiveId = content.id;
} else if (propId) {
  effectiveId = propId;
} else if (content?.id) {
  effectiveId = content.id;
} else {
  effectiveId = undefined;
}

// Helper: get banner text (bannerSpan / bannerTitle) with fallback
const getBannerText = (field: 'bannerSpan' | 'bannerTitle') => {
  // Search multiple locations for compatibility:
  // messages.slider[effectiveId].[field]
  // messages.sliderBanner[effectiveId].[field]
  if (effectiveId) {
    const bySlider = messages?.sliderBanner?.[effectiveId]?.[field];
    if (typeof bySlider === 'string') return bySlider;
    const byBanner = messages?.sliderBanner?.[effectiveId]?.[field];
    if (typeof byBanner === 'string') return byBanner;
  }
  // Fallback to content or default values
  if (content?.[field]) return content[field];
  if (field === 'bannerSpan') return 'Guatape-Colombia';
  if (field === 'bannerTitle') return 'El Bacchanal';
  return '';
};

// Helper: get array of translated images (if exists) - search in multiple paths
const getTranslatedImagesArray = () => {
  if (!effectiveId) return null;
  // Preferences: messages.slider[effectiveId].slider -> messages.slider[effectiveId].images
  const m = messages?.slider?.[effectiveId];
  if (m?.slider && Array.isArray(m.slider)) return m.slider;
  if (m?.images && Array.isArray(m.images)) return m.images;
  // fallback buscar en messages.sliderBanner
  const mb = messages?.sliderBanner?.[effectiveId];
  if (mb?.slider && Array.isArray(mb.slider)) return mb.slider;
  if (mb?.images && Array.isArray(mb.images)) return mb.images;
  return null;
};

// Helper: Get translated alt for slider array by index
const getSliderImageAlt = (index: number, fallbackAlt = '') => {
  const imgs = getTranslatedImagesArray();
  if (imgs && imgs[index] && typeof imgs[index].alt === 'string') return imgs[index].alt;
  return fallbackAlt;
};

// Helper: Get translated alt for single banner image (content.image)
const getSingleImageAlt = (fallbackAlt = '') => {
  if (!effectiveId) return fallbackAlt;
  const bySlider = messages?.slider?.[effectiveId]?.alt;
  if (typeof bySlider === 'string') return bySlider;
  const byBanner = messages?.sliderBanner?.[effectiveId]?.alt;
  if (typeof byBanner === 'string') return byBanner;
  // also look for content.image inside slider arrays (first element) if user stored alt there
  const imgs = getTranslatedImagesArray();
  if (imgs && imgs[0] && typeof imgs[0].alt === 'string') return imgs[0].alt;
  return fallbackAlt;
};
---

<section class='h-[100dvh] overflow-hidden'>
  {
    isSlider ? (
      <div class='swiper-banner relative h-full' id={propId}>
        <div class='swiper-wrapper'>
          {content?.slider?.map((item, idx) => {
            const altText = getSliderImageAlt(idx, item.alt ?? '');
            return (
              <div class='swiper-slide !h-full'>
                <Image
                  class='h-full w-full object-cover'
                  src={item.image}
                  alt={altText}
                  width={1920}
                  height={911}
                  loading={imageLoading}
                />
              </div>
            );
          })}
        </div>
        <div class={`${paginationPosition} swiper-pagination !w-fit`} />
        <div
          class:list={[
            contentPosition,
            { 'whitehella-style': isWhitehella },
            'font-koulen',
            'absolute',
          ]}
        >
          <span class='text-2xl leading-0 tracking-[13.75px]'>
            {getBannerText('bannerSpan')}
          </span>
          <p class='text-chart-6 text-[75px] leading-[1]'>
            {getBannerText('bannerTitle')}
          </p>
        </div>
      </div>
    ) : (
      <div class='relative h-full' id={propId}>
        {content?.image && (
          <Image
            class={'h-full w-full object-cover'}
            src={content.image}
            alt={getSingleImageAlt(content.alt ?? '')}
            width={1920}
            height={911}
            loading={imageLoading}
          />
        )}

        <div
          class:list={[
            contentPosition,
            { 'whitehella-style': isWhitehella },
            'font-koulen',
            'absolute',
          ]}
        >
          <span class='text-2xl leading-0 tracking-[13.75px]'>
            {getBannerText('bannerSpan')}
          </span>
          <p class='text-chart-6 text-[75px] leading-[1]'>{getBannerText('bannerTitle')}</p>
        </div>
      </div>
    )
  }
</section>
