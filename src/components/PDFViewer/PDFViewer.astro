---
/* PDFViewer.astro: fallback-only version */
import { Image } from 'astro:assets';
import type { PDFImage } from '@/types/types';
import './PDFViewer.css';
import '@/components/PDFViewer/PDFViewer.css';

const {
  redirectTo,
  buttonText,
  outWeb,
  content,
}: {
  redirectTo?: string;
  buttonText?: string;
  outWeb?: boolean;
  content?: PDFImage;
} = Astro.props;

// locale actual (server-side)
const currentLang = Astro.currentLocale ?? 'es';

// load translations (build-time)
const translations = import.meta.glob('/src/i18n/*.ts', { eager: true }) as Record<string, any>;
const messages =
  translations[`/src/i18n/${currentLang}.ts`]?.default
  ?? translations[`/src/i18n/${currentLang}.js`]?.default
  ?? {};

const getTranslation = (field: keyof PDFImage) => {
  const id = content?.id;
  if (!id) return content?.[field as keyof PDFImage] ?? '';
  const translated = messages?.pdfImage?.[id]?.[field as string];
  return translated ?? content?.[field as keyof PDFImage] ?? '';
};

// Extract messages from the viewer with fallbacks
const pv = messages?.pdfViewer ?? {};
const fallbackTitle = pv.fallbackTitle ?? 'The PDF cannot be displayed.';
const fallbackMessage = pv.fallbackMessage ?? 'You can open the PDF in a new window to view it';
const pdfFoodLabel = pv.pdfFood ?? 'Food Menu PDF';
const pdfDrinkLabel = pv.pdfDrink ?? 'Drink Menu PDF';
const openBtnLabel = pv.openBtn ?? 'Open PDF';
const langLabel = pv.langLabel ?? 'Language';
const saveBtnLabel = pv.saveBtn ?? 'Save';
const loadingLabel = pv.loading ?? 'Loading PDFâ€¦'; // optional key 'loading'
---
<div 
  id="pdf-container" 
  class="pdf-viewer-container h-[100dvh]"
  data-button-text={buttonText ?? ''}
  data-redirect-to={redirectTo ?? ''}
  data-out-web={String(outWeb ?? false)}
  data-lang={currentLang}
  data-lang-label={langLabel}
  data-save-label={saveBtnLabel}
>
  
  <div id="pdf-fallback" class="pdf-fallback" >
    
            <div class="flex fallback-links">
              <div class="pdf-link-menu">
                <p class="font-whitehella text-gradient-bacchanal text-[35px]" id="pdf-food-title">{pdfFoodLabel}</p>
                <div class="fallback-buttons">
                  <a
                  id="open-food-btn"
                  class="pdf-button"
                  href="#"
                  target="_blank"
                  rel="noopener noreferrer"
                  >
                  {openBtnLabel}
                  <div class="button-overlay"></div>
                  </a>
              </div>
            </div>

            <div class={`flex items-center justify-center xl:gap-x-20 2xl:gap-x-28 text-image-content`}>
                {
                  content?.image && (
                    <Image
                      src={content.image}
                      alt={getTranslation('alt')}
                      width={content.width}
                      height={content.height}
                      class='1xl:max-w-[550px] lg:max-w-[512px] 2xl:max-w-[700px]'
                    />
                  )
                }
            </div>

            <div class="pdf-link-menu">
              <p class="font-whitehella text-gradient-bacchanal text-[35px]" id="pdf-drink-title">{pdfDrinkLabel}</p>
              <div class="fallback-buttons">
                <a
                id="open-drink-btn"
                class="pdf-button"
                href="#"
                target="_blank"
                rel="noopener noreferrer"
                >
                {openBtnLabel}
                <div class="button-overlay"></div>
              </a>
            </div>
          </div>
        </div>
        <svg
                        class='waves-pdf'
                        viewBox='0 0 600 600'
                        xmlns='http://www.w3.org/2000/svg'
                        preserveAspectRatio='xMidYMid meet'
                      >
                        <defs>
                          <linearGradient id='waveGradient' x1='0%' y1='0%' x2='100%' y2='100%'>
                            <stop offset='0%' stop-color='#fff' stop-opacity='0.3'></stop>
                            <stop offset='50%' stop-color='#fff' stop-opacity='0.2'></stop>
                            <stop offset='100%' stop-color='#fff' stop-opacity='0.1'></stop>
                          </linearGradient>
                        </defs>
      
                        <circle
                          cx='300'
                          cy='300'
                          r='50'
                          fill='none'
                          stroke='url(#waveGradient)'
                          stroke-width='2'
                          class='animate-wave-1'></circle>
      
                        <circle
                          cx='300'
                          cy='300'
                          r='80'
                          fill='none'
                          stroke='url(#waveGradient)'
                          stroke-width='1.5'
                          class='animate-wave-2'></circle>
      
                        <circle
                          cx='300'
                          cy='300'
                          r='110'
                          fill='none'
                          stroke='url(#waveGradient)'
                          stroke-width='1'
                          class='animate-wave-3'></circle>
      
                        <circle
                          cx='300'
                          cy='300'
                          r='140'
                          fill='none'
                          stroke='url(#waveGradient)'
                          stroke-width='0.5'
                          class='animate-wave-4'></circle>
      
                        <circle
                          cx='300'
                          cy='300'
                          r='170'
                          fill='none'
                          stroke='url(#waveGradient)'
                          stroke-width='0.3'
                          class='animate-wave-5'></circle>
        </svg>
      </div>

  </div>
  
  <p id="pdf-loading" class="loading-message" style="display:none;">{loadingLabel}</p>

</div>

<script>
(function () {
  // PDF URLs by language
  const PDFs = {
    en: {
      food: '/docs/Menu-Food-English.pdf',
      drink: '/docs/Menu-Drink-English.pdf'
    },
    es: {
      food: '/docs/Menu-Food-Spanish.pdf',
      drink: '/docs/Menu-Drink-Spanish.pdf'
    }
  };

  // detectLanguage sin tipos TS (cliente)
  function detectLanguage() {
    try {
      const q = new URLSearchParams(location.search);
      const qLang = q.get('lang');
      if (qLang) return qLang.split('-')[0].toLowerCase().startsWith('es') ? 'es' : 'en';
    } catch (e) {}
    const stored = localStorage.getItem('preferredLang');
    if (stored === 'es' || stored === 'en') return stored;
    const container = document.getElementById('pdf-container');
    if (container && container.dataset && (container.dataset.lang === 'es' || container.dataset.lang === 'en')) {
      return container.dataset.lang;
    }
    const nav = (navigator.languages && navigator.languages.length) ? navigator.languages[0] : (navigator.language || 'en');
    const code = String(nav).split('-')[0].toLowerCase();
    if (code === 'es') return 'es';
    return 'en';
  }

  // Selectores DOM
  function $ (id: string) { return document.getElementById(id); }
  const container = $('pdf-container');
  const openFoodBtn = $('open-food-btn');
  const openDrinkBtn = $('open-drink-btn');
  const fallbackElem = $('pdf-fallback');
  const loadingElem = $('pdf-loading');
  const selectLang = $('lang-switch');
  const langSaveBtn = $('lang-save-btn');

  // Helpers UI
  function showFallback() {
    if (loadingElem) loadingElem.style.display = 'none';
    if (fallbackElem) fallbackElem.style.display = 'block';
  }

  function setupCustomButton() {
    const customBtn = document.getElementById('custom-btn');
    const buttonText = container && container.dataset && container.dataset.buttonText ? container.dataset.buttonText : '';
    const redirectTo = container && container.dataset && container.dataset.redirectTo ? container.dataset.redirectTo : '';
    const outWeb = container && container.dataset && container.dataset.outWeb === 'true';

    if (!customBtn) return;

    // only if it is anchor
    if (customBtn instanceof HTMLAnchorElement) {
      if (buttonText && redirectTo) {
        customBtn.style.display = 'flex';
        customBtn.textContent = buttonText;
        customBtn.href = redirectTo;
        if (outWeb) {
          customBtn.target = '_blank';
          customBtn.rel = 'noopener noreferrer';
        } else {
          customBtn.target = '_self';
          customBtn.removeAttribute('rel');
        }
      }
    } else {
      // If it's another type of element, just set text and dataset.href (not common)
      if (buttonText) customBtn.textContent = buttonText;
    }
  }

  // Execute when DOM is loaded
  document.addEventListener('DOMContentLoaded', function () {
    const lang = detectLanguage();
    document.documentElement.lang = lang;

    // Sync select if exists
    if (selectLang && selectLang instanceof HTMLSelectElement) selectLang.value = lang;

    if (langSaveBtn && selectLang && selectLang instanceof HTMLSelectElement) {
      langSaveBtn.addEventListener('click', function () {
        const selected = selectLang.value === 'es' ? 'es' : 'en';
        localStorage.setItem('preferredLang', selected);
        location.reload();
      });
    }

    // PDF paths according to detected language
    var pdfFoodUrl = (PDFs[lang] && PDFs[lang].food) ? PDFs[lang].food : PDFs.en.food;
    var pdfDrinkUrl = (PDFs[lang] && PDFs[lang].drink) ? PDFs[lang].drink : PDFs.en.drink;

    if (openFoodBtn && openFoodBtn instanceof HTMLAnchorElement) {
      openFoodBtn.href = pdfFoodUrl;
      openFoodBtn.target = '_blank';
      openFoodBtn.rel = 'noopener noreferrer';
    }
    if (openDrinkBtn && openDrinkBtn instanceof HTMLAnchorElement) {
      openDrinkBtn.href = pdfDrinkUrl;
      openDrinkBtn.target = '_blank';
      openDrinkBtn.rel = 'noopener noreferrer';
    }

    showFallback();

    setupCustomButton();
  });
})();
</script>
